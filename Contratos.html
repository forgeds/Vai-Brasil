<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Parcelas - Vários Clientes</title>
  <!-- Biblioteca para exportar para Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    /* Reset básico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    /* Corpo da página */
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f9f9f9;
      color: #333;
      padding: 20px;
    }
    
    /* Container principal */
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Títulos */
    h2 {
      margin-bottom: 20px;
      color: #444;
    }
    
    /* Formulário de cadastro */
    form, .cadastro {
      background: #fff;
      padding: 20px;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
    }
    
    form label, .cadastro label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    form input[type="text"],
    form input[type="date"],
    form input[type="number"],
    .cadastro input[type="text"],
    .cadastro input[type="date"],
    .cadastro input[type="number"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    form button, .cadastro button {
      margin-top: 10px;
      background-color: #3498db;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    
    form button:hover, .cadastro button:hover {
      background-color: #2980b9;
    }
    
    /* Tabela de dados */
    table {
      width: 100%;
      border-collapse: collapse;
      background-color: #fff;
      margin-bottom: 30px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    
    table th,
    table td {
      padding: 12px;
      border: 1px solid #ddd;
      text-align: center;
    }
    
    table th {
      background-color: #3498db;
      color: #fff;
      font-weight: normal;
    }
    
    /* Cabeçalho do contrato */
    .contract-header {
      background-color: #e9f5ff;
      cursor: pointer;
      font-weight: bold;
      font-size: 18px;
    }
    
    .contract-header button {
      background-color: #2ecc71;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-left: 10px;
    }
    
    .contract-header button:hover {
      background-color: #27ae60;
    }
    
    /* Botões na tabela */
    table button {
      background-color: #2ecc71;
      border: none;
      color: #fff;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    
    table button:hover {
      background-color: #27ae60;
    }
    
    /* Botão de exportar */
    .export-btn {
      background-color: #e67e22;
      border: none;
      color: #fff;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-bottom: 20px;
    }
    
    .export-btn:hover {
      background-color: #d35400;
    }
    
    /* Responsividade */
    @media (max-width: 768px) {
      table, form, h2 {
        font-size: 14px;
      }
      form button, .export-btn {
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Cadastro de Contrato e Parcelas</h2>
    <div class="cadastro">
      <label>Nome: <input type="text" id="nome"></label>
      <label>CPF: <input type="text" id="cpf"></label>
      <label>Número do Contrato: <input type="text" id="contrato"></label>
      <label>Valor da Parcela: <input type="number" id="valor" step="0.01"></label>
      <label>Data do 1º Vencimento: <input type="date" id="vencimento"></label>
      <label>Quantidade de Parcelas: <input type="number" id="parcelas" min="1"></label>
      <button onclick="adicionarPagamento()">Adicionar Contrato</button>
    </div>

    <h2>Controle de Parcelas</h2>
    <table id="tabelaParcelas">
      <thead>
        <tr>
          <th>Detalhes</th>
        </tr>
      </thead>
      <tbody id="corpoTabela"></tbody>
    </table>
    <button class="export-btn" onclick="exportarParaExcel()">Exportar para Excel</button>
  </div>

  <script>
    // Recupera os dados do localStorage ou inicia com array vazio
    let parcelas = JSON.parse(localStorage.getItem('parcelas')) || [];
    // Objeto para armazenar o estado de exibição de cada contrato (true: expandido)
    let contratosToggle = {};

    // Função para adicionar meses a uma data
    function addMonths(date, months) {
      let d = new Date(date);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    // Função para adicionar um contrato e suas parcelas
    function adicionarPagamento() {
      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const contrato = document.getElementById('contrato').value.trim();
      const valor = parseFloat(document.getElementById('valor').value);
      const vencimentoStr = document.getElementById('vencimento').value;
      const qtdParcelas = parseInt(document.getElementById('parcelas').value);

      if (!nome || !cpf || !contrato || isNaN(valor) || !vencimentoStr || isNaN(qtdParcelas) || qtdParcelas < 1) {
        alert('Preencha todos os campos corretamente!');
        return;
      }

      // Gerar um id único para o contrato
      const contratoId = Date.now().toString();

      for (let i = 0; i < qtdParcelas; i++) {
        let novaData = addMonths(new Date(vencimentoStr), i);
        let novaDataStr = novaData.toISOString().split('T')[0];
        let parcelaObj = {
          id: contratoId + '-' + (i + 1),
          contratoId: contratoId,
          contrato: contrato,
          nome: nome,
          cpf: cpf,
          parcela: i + 1,
          totalParcelas: qtdParcelas,
          vencimento: novaDataStr,
          valor: valor,
          paid: false
        };
        parcelas.push(parcelaObj);
      }
      localStorage.setItem('parcelas', JSON.stringify(parcelas));
      limparFormulario();
      listarParcelas();
    }

    // Função para limpar o formulário após cadastro ou edição
    function limparFormulario() {
      document.getElementById('nome').value = '';
      document.getElementById('cpf').value = '';
      document.getElementById('contrato').value = '';
      document.getElementById('valor').value = '';
      document.getElementById('vencimento').value = '';
      document.getElementById('parcelas').value = '';
    }

    // Função para listar os contratos e suas parcelas
    function listarParcelas() {
      const corpoTabela = document.getElementById('corpoTabela');
      corpoTabela.innerHTML = '';

      // Agrupar parcelas por contratoId
      let grupos = {};
      parcelas.forEach(p => {
        if (!grupos[p.contratoId]) {
          grupos[p.contratoId] = [];
        }
        grupos[p.contratoId].push(p);
      });

      // Ordenar os grupos pela data de vencimento da primeira parcela
      let gruposOrdenados = Object.values(grupos).sort((a, b) => new Date(a[0].vencimento) - new Date(b[0].vencimento));
      const hoje = new Date();

      gruposOrdenados.forEach(grupo => {
        grupo.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));
        const contratoId = grupo[0].contratoId;
        // Cria a linha de cabeçalho do contrato com botões para toggle, editar e excluir
        const headerRow = document.createElement('tr');
        headerRow.classList.add('contract-header');
        const headerCell = document.createElement('td');
        headerCell.colSpan = 5;
        headerCell.innerHTML = `<strong>Contrato: ${grupo[0].contrato} | Cliente: ${grupo[0].nome} | CPF: ${grupo[0].cpf}</strong>
          <button onclick="toggleContract('${contratoId}'); event.stopPropagation();">
            ${contratosToggle[contratoId] ? 'Esconder Parcelas' : 'Mostrar Parcelas'}
          </button>
          <button onclick="editarContrato('${contratoId}'); event.stopPropagation();">Editar</button>
          <button onclick="excluirContrato('${contratoId}'); event.stopPropagation();">Excluir</button>`;
        headerRow.appendChild(headerCell);
        headerRow.onclick = function() {
          toggleContract(contratoId);
        };
        corpoTabela.appendChild(headerRow);

        // Se o contrato estiver expandido, mostra as parcelas
        if (contratosToggle[contratoId]) {
          const subHeaderRow = document.createElement('tr');
          subHeaderRow.innerHTML = `<th>Parcela</th>
            <th>Vencimento</th>
            <th>Valor</th>
            <th>Status</th>
            <th>Ação</th>`;
          corpoTabela.appendChild(subHeaderRow);

          grupo.forEach(p => {
            const row = document.createElement('tr');
            const vencimentoDate = new Date(p.vencimento);
            const diffMs = vencimentoDate - hoje;
            const diffDias = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
            let status = '';
            if (p.paid) {
              status = 'Pago';
            } else {
              if (diffDias < 0) {
                status = `Atrasado ${Math.abs(diffDias)} dia(s)`;
              } else if (diffDias === 0) {
                status = 'Vence hoje';
              } else {
                status = `Faltam ${diffDias} dia(s)`;
              }
            }
            row.innerHTML = `<td>${p.parcela}/${p.totalParcelas}</td>
              <td>${p.vencimento}</td>
              <td>${p.valor.toFixed(2)}</td>
              <td>${status}</td>
              <td><button onclick="togglePagamento('${p.id}')">${p.paid ? 'Desmarcar' : 'Marcar como Pago'}</button></td>`;
            corpoTabela.appendChild(row);
          });
        }
      });
    }

    // Função para alternar o status de pagamento de uma parcela
    function togglePagamento(id) {
      const index = parcelas.findIndex(p => p.id === id);
      if (index !== -1) {
        parcelas[index].paid = !parcelas[index].paid;
        localStorage.setItem('parcelas', JSON.stringify(parcelas));
        listarParcelas();
      }
    }

    // Função para expandir/ocultar as parcelas de um contrato
    function toggleContract(contratoId) {
      contratosToggle[contratoId] = !contratosToggle[contratoId];
      listarParcelas();
    }

    // Função para editar um contrato
    function editarContrato(contratoId) {
      const grupo = parcelas.filter(p => p.contratoId === contratoId);
      if (grupo.length === 0) return;
      const contratoRecord = grupo[0];
      document.getElementById('nome').value = contratoRecord.nome;
      document.getElementById('cpf').value = contratoRecord.cpf;
      document.getElementById('contrato').value = contratoRecord.contrato;
      document.getElementById('valor').value = contratoRecord.valor;
      document.getElementById('vencimento').value = contratoRecord.vencimento;
      document.getElementById('parcelas').value = contratoRecord.totalParcelas;
      // Remove os registros atuais do contrato para que a edição gere novos dados ao salvar
      parcelas = parcelas.filter(p => p.contratoId !== contratoId);
      localStorage.setItem('parcelas', JSON.stringify(parcelas));
      listarParcelas();
    }

    // Função para excluir um contrato
    function excluirContrato(contratoId) {
      if (confirm("Deseja excluir o contrato?")) {
        parcelas = parcelas.filter(p => p.contratoId !== contratoId);
        localStorage.setItem('parcelas', JSON.stringify(parcelas));
        listarParcelas();
      }
    }

    // Função para exportar os dados para Excel
    function exportarParaExcel() {
      const ws = XLSX.utils.json_to_sheet(parcelas);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Parcelas');
      XLSX.writeFile(wb, 'parcelas.xlsx');
    }

    listarParcelas();
  </script>
</body>
</html>
