<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Parcelas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>
    <h1>Controle de Parcelas</h1>
    
    <h2>Adicionar Pagamento</h2>
    <form id="formPagamento">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" required><br><br>

        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" required><br><br>

        <label for="contrato">Número do Contrato:</label>
        <input type="text" id="contrato" required><br><br>

        <label for="valor">Valor da Parcela (R$):</label>
        <input type="number" id="valor" required><br><br>

        <label for="vencimento">Data de Vencimento:</label>
        <input type="date" id="vencimento" required><br><br>

        <label for="parcelas">Número de Parcelas:</label>
        <input type="number" id="parcelas" min="1" required><br><br>

        <button type="button" onclick="adicionarPagamento()">Adicionar Pagamento</button>
    </form>

    <h2>Parcelas Cadastradas</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Detalhes</th>
                <th>Ação</th>
            </tr>
        </thead>
        <tbody id="corpoTabela">
            <!-- Parcelas serão listadas aqui -->
        </tbody>
    </table>

    <script>
        // Configuração do Supabase
        const supabaseUrl = 'https://your-project.supabase.co'; // Substitua pela sua URL
        const supabaseKey = 'your-public-anon-key'; // Substitua pela sua chave pública
        const supabase = supabase.createClient(supabaseUrl, supabaseKey);

        // Função para adicionar um pagamento
        async function adicionarPagamento() {
            const nome = document.getElementById('nome').value.trim();
            const cpf = document.getElementById('cpf').value.trim();
            const contrato = document.getElementById('contrato').value.trim();
            const valor = parseFloat(document.getElementById('valor').value);
            const vencimentoStr = document.getElementById('vencimento').value;
            const qtdParcelas = parseInt(document.getElementById('parcelas').value);

            if (!nome || !cpf || !contrato || isNaN(valor) || !vencimentoStr || isNaN(qtdParcelas) || qtdParcelas < 1) {
                alert('Preencha todos os campos corretamente!');
                return;
            }

            // Gerar um id único para o contrato
            const contratoId = Date.now().toString();

            for (let i = 0; i < qtdParcelas; i++) {
                let novaData = addMonths(new Date(vencimentoStr), i);
                let novaDataStr = novaData.toISOString().split('T')[0];
                let parcelaObj = {
                    contrato_id: contratoId,
                    contrato: contrato,
                    nome: nome,
                    cpf: cpf,
                    parcela: i + 1,
                    total_parcelas: qtdParcelas,
                    vencimento: novaDataStr,
                    valor: valor,
                    paid: false
                };

                // Inserir no Supabase
                const { data, error } = await supabase
                    .from('parcelas')  // Nome da tabela que você criou no Supabase
                    .insert([parcelaObj]);

                if (error) {
                    alert('Erro ao adicionar pagamento: ' + error.message);
                    return;
                }
            }

            limparFormulario();
            listarParcelas();
        }

        // Função para listar as parcelas
        async function listarParcelas() {
            const { data, error } = await supabase
                .from('parcelas')
                .select('*')
                .order('vencimento', { ascending: true });

            if (error) {
                alert('Erro ao carregar parcelas: ' + error.message);
                return;
            }

            const corpoTabela = document.getElementById('corpoTabela');
            corpoTabela.innerHTML = '';

            data.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.contrato} | ${p.nome} | ${p.cpf} | ${p.parcela}/${p.total_parcelas} | ${p.vencimento} | R$ ${p.valor.toFixed(2)}</td>
                    <td><button onclick="togglePagamento(${p.id})">${p.paid ? 'Desmarcar' : 'Marcar como Pago'}</button></td>
                `;
                corpoTabela.appendChild(row);
            });
        }

        // Função para alternar o status de pagamento
        async function togglePagamento(id) {
            const { data, error } = await supabase
                .from('parcelas')
                .update({ paid: true })
                .eq('id', id);

            if (error) {
                alert('Erro ao atualizar pagamento: ' + error.message);
                return;
            }

            listarParcelas();
        }

        // Função para limpar o formulário após cadastro
        function limparFormulario() {
            document.getElementById('nome').value = '';
            document.getElementById('cpf').value = '';
            document.getElementById('contrato').value = '';
            document.getElementById('valor').value = '';
            document.getElementById('vencimento').value = '';
            document.getElementById('parcelas').value = '';
        }
        
        // Função para adicionar meses a uma data
        function addMonths(date, months) {
            let d = new Date(date);
            d.setMonth(d.getMonth() + months);
            return d;
        }

        // Carregar parcelas ao iniciar
        listarParcelas();
    </script>
</body>
</html>
