<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Controle de Parcelas</title>
  <link href="stylesheet.css" rel="stylesheet">
  <!-- N√£o √© necess√°rio incluir os scripts do Firebase no head quando usamos m√≥dulos -->
</head>
<body>
  <nav class="navigation-bar">
    <div class="nav-buttons">
      <button onclick="window.location.href='index.html'" class="nav-button">
        <span class="nav-icon">üìù</span>
        Cadastro
      </button>
      <button onclick="window.location.href='Boletos.html'" class="nav-button">
        <span class="nav-icon">üìÑ</span>
        Boletos
      </button>
      <button onclick="window.location.href='gerenciamento.html'" class="nav-button">
        <span class="nav-icon">‚öôÔ∏è</span>
        Gerenciamento
      </button>
    </div>
  </nav>
  <h1>Controle de Parcelas</h1>

  <div class="tab-buttons">
    <button class="tab-button active" onclick="mostrarAba('cadastro')">Cadastro</button>
    <button class="tab-button" onclick="mostrarAba('clientes')">Clientes</button>
    <button onclick="exportarJSON()">Exportar JSON</button>
    <button onclick="importarJSON()">Importar JSON</button>
    <input type="file" id="importFile" style="display: none;" accept=".json">
  </div>

  <div id="cadastro" class="tab-content">
    <h2 id="titulo-formulario">Adicionar Pagamento</h2>
    <form id="formPagamento">
      <input type="hidden" id="editandoId" value="">
      <input type="hidden" id="modoEdicao" value="false">

      <div class="form-group">
        <label for="nome">Nome:</label>
        <input type="text" id="nome" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="cpf">CPF:</label>
        <input type="text" id="cpf" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="contrato">N√∫mero do Contrato:</label>
        <input type="text" id="contrato" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="valorTotal">Valor Total (R$):</label>
        <input type="number" id="valorTotal" class="form-control" required>
      </div>

      <div class="form-group">
        <label for="valorEntrada">Valor da Entrada (R$):</label>
        <input type="number" id="valorEntrada" class="form-control" value="0">
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="entradaParcelada"> Parcelar Entrada
        </label>
      </div>
      
      <div class="form-group" id="camposParcelasEntrada" style="display: none;">
        <label for="parcelasEntrada">N√∫mero de Parcelas da Entrada:</label>
        <input type="number" id="parcelasEntrada" class="form-control" value="1" min="1">
      </div>
      
      <div class="form-group">
        <label>
          <input type="checkbox" id="temParcelas" checked> Parcelar Valor Restante
        </label>
      </div>
      

      <div id="camposParcelas">
        <div class="form-group">
          <label for="parcelas">N√∫mero de Parcelas:</label>
          <input type="number" id="parcelas" min="1" class="form-control" value="1" required>
        </div>

        <div class="form-group">
          <label for="inicioParcelas">Data de In√≠cio das Parcelas:</label>
          <input type="date" id="inicioParcelas" class="form-control" required>
        </div>
      </div>

      <div class="btn-group">
        <button type="button" id="btnSalvar" onclick="adicionarPagamento()">Adicionar Pagamento</button>
        <button type="button" id="btnCancelar" onclick="cancelarEdicao()" style="display:none;">Cancelar Edi√ß√£o</button>
      </div>
    </form>
  </div>

  <div id="clientes" class="tab-content" style="display:none;">
    <h2>Clientes e Parcelas</h2>

    <div class="filter-section">
      <div class="search-box">
        <input type="text" id="pesquisaCliente" placeholder="Pesquisar cliente (nome, CPF ou contrato)" class="form-control">
        <button onclick="pesquisarClientes()">Buscar</button>
      </div>

      <div>
        <label><input type="checkbox" id="mostrarPendentes" checked> Pendentes</label>
        <label><input type="checkbox" id="mostrarPagos" checked> Pagos</label>
        <label><input type="checkbox" id="mostrarAtrasados" checked> Atrasados</label>
      </div>
    </div>

    <button class="toggle-all-button" onclick="toggleTodosClientes()">Expandir/Contrair Todos</button>

    <div id="listaClientes">
      <!-- Clientes ser√£o listados aqui -->
    </div>
  </div>

  <!-- Modal de confirma√ß√£o para exclus√£o -->
  <div id="modalConfirmacao" class="modal" style="display:none;">
    <div class="modal-content">
      <h3>Confirma√ß√£o de Exclus√£o</h3>
      <p>Tem certeza que deseja excluir este contrato? Esta a√ß√£o n√£o pode ser desfeita.</p>
      <div class="modal-buttons">
        <button onclick="confirmarExclusao()">Sim, Excluir</button>
        <button onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- Script principal com integra√ß√£o Firebase -->
  <script type="module">
    // Importar os m√≥dulos do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, query, where, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Configura√ß√£o do Firebase ‚Äì substitua pelos seus dados
    const firebaseConfig = {
      apiKey: "SUA_API_KEY",
      authDomain: "SEU_DOMINIO.firebaseapp.com",
      projectId: "SEU_PROJECT_ID",
      storageBucket: "SEU_BUCKET.appspot.com",
      messagingSenderId: "SEU_SENDER_ID",
      appId: "SEU_APP_ID"
    };

    // Inicializar o Firebase e o Firestore
    const appFirebase = initializeApp(firebaseConfig);
    const db = getFirestore(appFirebase);

    // Vari√°veis globais
    let clientesExpandidos = {};
    window.contratoParaExcluir = null;

    // Fun√ß√£o para adicionar pagamento (ou atualizar, se em modo de edi√ß√£o)
    async function adicionarPagamento() {
      const nome = document.getElementById('nome').value.trim();
      const cpf = document.getElementById('cpf').value.trim();
      const contrato = document.getElementById('contrato').value.trim();
      const valorTotal = parseFloat(document.getElementById('valorTotal').value);
      const valorEntrada = parseFloat(document.getElementById('valorEntrada').value) || 0;
      const temParcelas = document.getElementById('temParcelas').checked;
      const entradaParcelada = document.getElementById('entradaParcelada').checked;
      const parcelasEntrada = entradaParcelada ? parseInt(document.getElementById('parcelasEntrada').value) : 1;
      
      let qtdParcelas = 1;
      let inicioParcelasStr = new Date().toISOString().split('T')[0];

      if (temParcelas) {
        qtdParcelas = parseInt(document.getElementById('parcelas').value);
        inicioParcelasStr = document.getElementById('inicioParcelas').value;
      }

      if (!nome || !cpf || !contrato || isNaN(valorTotal) || qtdParcelas < 1 || !inicioParcelasStr) {
        alert('Preencha todos os campos corretamente!');
        return;
      }

      const modoEdicao = document.getElementById('modoEdicao').value === 'true';
      let contratoId = "";
      if (modoEdicao) {
        contratoId = document.getElementById('editandoId').value;
        // Excluir parcelas antigas deste contrato
        await excluirParcelasPorContrato(contratoId);
      } else {
        contratoId = Date.now().toString();
      }

      // Gerar array de parcelas
      const novasParcelas = gerarParcelasContrato(contratoId, nome, cpf, contrato, valorTotal, valorEntrada, qtdParcelas, inicioParcelasStr, parcelasEntrada);
      
      try {
        for (const parcela of novasParcelas) {
          await addDoc(collection(db, "parcelas"), parcela);
        }
        alert(modoEdicao ? 'Contrato atualizado com sucesso!' : 'Pagamento cadastrado com sucesso!');
        limparFormulario();
        cancelarEdicao();
        listarClientes();
      } catch (error) {
        console.error("Erro ao salvar:", error);
        alert("Erro ao salvar pagamento!");
      }
    }

    // Fun√ß√£o que gera o array de parcelas (substitui adicionarParcelasContrato)
    function gerarParcelasContrato(contratoId, nome, cpf, contrato, valorTotal, valorEntrada, qtdParcelas, inicioParcelasStr, parcelasEntrada = 1) {
      const parcelasArray = [];
      const inicioDate = new Date(inicioParcelasStr);
      
      // Entrada
      if (valorEntrada > 0) {
        if (parcelasEntrada > 1) {
          const valorParcelaEntrada = valorEntrada / parcelasEntrada;
          for (let i = 0; i < parcelasEntrada; i++) {
            let dataEntrada = addMonths(inicioDate, i);
            let dataEntradaStr = dataEntrada.toISOString().split('T')[0];
            parcelasArray.push({
              contrato_id: contratoId,
              contrato: contrato,
              nome: nome,
              cpf: cpf,
              parcela: i + 1,
              total_parcelas: parcelasEntrada,
              vencimento: dataEntradaStr,
              valor: valorParcelaEntrada,
              paid: false,
              tipo: "Entrada Parcelada"
            });
          }
        } else {
          parcelasArray.push({
            contrato_id: contratoId,
            contrato: contrato,
            nome: nome,
            cpf: cpf,
            parcela: 1,
            total_parcelas: 1,
            vencimento: inicioParcelasStr,
            valor: valorEntrada,
            paid: false,
            tipo: "Entrada √† Vista"
          });
        }
      }
      
      // Parcelas regulares para o valor restante
      const valorParcelado = valorTotal - valorEntrada;
      if (qtdParcelas > 1) {
        const valorParcela = valorParcelado / qtdParcelas;
        const offsetMeses = valorEntrada > 0 ? parcelasEntrada : 0;
        for (let i = 0; i < qtdParcelas; i++) {
          let novaData = addMonths(inicioDate, i + offsetMeses);
          let novaDataStr = novaData.toISOString().split('T')[0];
          parcelasArray.push({
            contrato_id: contratoId,
            contrato: contrato,
            nome: nome,
            cpf: cpf,
            parcela: i + 1,
            total_parcelas: qtdParcelas,
            vencimento: novaDataStr,
            valor: valorParcela,
            paid: false,
            tipo: "Parcela Regular"
          });
        }
      } else if (valorParcelado > 0) {
        parcelasArray.push({
          contrato_id: contratoId,
          contrato: contrato,
          nome: nome,
          cpf: cpf,
          parcela: 1,
          total_parcelas: 1,
          vencimento: inicioParcelasStr,
          valor: valorParcelado,
          paid: false,
          tipo: "Pagamento √† Vista"
        });
      }
      return parcelasArray;
    }

    // Fun√ß√£o para adicionar meses a uma data
    function addMonths(date, months) {
      let d = new Date(date);
      d.setMonth(d.getMonth() + months);
      return d;
    }

    // Fun√ß√£o para listar os clientes, agrupando as parcelas obtidas do Firestore
    async function listarClientes() {
      const listaClientes = document.getElementById('listaClientes');
      listaClientes.innerHTML = '';

      try {
        const querySnapshot = await getDocs(collection(db, "parcelas"));
        const parcelas = [];
        querySnapshot.forEach((docSnap) => {
          let data = docSnap.data();
          data.id = docSnap.id;
          parcelas.push(data);
        });

        const mostrarPendentes = document.getElementById('mostrarPendentes').checked;
        const mostrarPagos = document.getElementById('mostrarPagos').checked;
        const mostrarAtrasados = document.getElementById('mostrarAtrasados').checked;
        const termoPesquisa = document.getElementById('pesquisaCliente').value.toLowerCase();

        // Agrupar por cliente (nome + CPF)
        const clientesMap = {};
        parcelas.forEach(p => {
          const chaveCliente = `${p.nome}_${p.cpf}`;
          if (!clientesMap[chaveCliente]) {
            clientesMap[chaveCliente] = { nome: p.nome, cpf: p.cpf, parcelas: [] };
          }
          clientesMap[chaveCliente].parcelas.push(p);
        });

        const clientes = Object.values(clientesMap).sort((a, b) => a.nome.localeCompare(b.nome));
        const hoje = new Date();
        hoje.setHours(0, 0, 0, 0);

        clientes.forEach(cliente => {
          if (termoPesquisa && !clienteCorrespondeAPesquisa(cliente, termoPesquisa)) {
            return;
          }
          cliente.parcelas.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento));
          const contratos = {};
          cliente.parcelas.forEach(p => {
            if (!contratos[p.contrato_id]) {
              contratos[p.contrato_id] = { id: p.contrato_id, numero: p.contrato, parcelas: [] };
            }
            contratos[p.contrato_id].parcelas.push(p);
          });

          const totalParcelas = cliente.parcelas.length;
          const parcelasPagas = cliente.parcelas.filter(p => p.paid).length;
          const valorTotal = cliente.parcelas.reduce((sum, p) => sum + p.valor, 0);
          const valorPago = cliente.parcelas.filter(p => p.paid).reduce((sum, p) => sum + p.valor, 0);
          const temAtrasadas = cliente.parcelas.some(p => !p.paid && new Date(p.vencimento) < hoje);
          let statusCliente = "Em dia";
          let statusClass = "status-ok";
          if (temAtrasadas) {
            statusCliente = "Atrasado";
            statusClass = "status-atrasado";
          } else if (totalParcelas > parcelasPagas) {
            statusCliente = "Pendente";
            statusClass = "status-pendente";
          }
          if ((temAtrasadas && !mostrarAtrasados) ||
              (parcelasPagas === totalParcelas && !mostrarPagos) ||
              (parcelasPagas < totalParcelas && !temAtrasadas && !mostrarPendentes)) {
            return;
          }
          const clienteCard = document.createElement('div');
          clienteCard.className = 'cliente-card';

          const clienteHeader = document.createElement('div');
          clienteHeader.className = 'cliente-header';
          clienteHeader.onclick = () => toggleParcelas(cliente.nome + cliente.cpf);
          clienteHeader.innerHTML = `
            <strong>${cliente.nome}</strong> (CPF: ${formatarCPF(cliente.cpf)})
            <span class="cliente-status ${statusClass}">${statusCliente}</span>
          `;

          const clienteResumo = document.createElement('div');
          clienteResumo.className = 'resumo-cliente';
          clienteResumo.innerHTML = `
            Total: R$ ${valorTotal.toFixed(2)} | 
            Pago: R$ ${valorPago.toFixed(2)} (${parcelasPagas}/${totalParcelas} parcelas) | 
            Restante: R$ ${(valorTotal - valorPago).toFixed(2)}
          `;

          const clienteParcelas = document.createElement('div');
          clienteParcelas.className = 'cliente-parcelas';
          clienteParcelas.id = `parcelas-${cliente.nome}${cliente.cpf}`;
          if (clientesExpandidos[cliente.nome + cliente.cpf]) {
            clienteParcelas.style.display = 'block';
          }

          let contratoHTML = "";
          Object.values(contratos).forEach(contrato => {
            const contratoTotal = contrato.parcelas.reduce((sum, p) => sum + p.valor, 0);
            const contratoPago = contrato.parcelas.filter(p => p.paid).reduce((sum, p) => sum + p.valor, 0);
            contratoHTML += `
              <div class="contrato-section">
                <div class="contrato-header">
                  <h3>Contrato: ${contrato.numero}</h3>
                  <div class="contrato-actions">
                    <button onclick="editarContrato('${contrato.id}')">Editar</button>
                    <button onclick="excluirContrato('${contrato.id}')">Excluir</button>
                  </div>
                </div>
                <div class="contrato-info">
                  Total: R$ ${contratoTotal.toFixed(2)} | 
                  Pago: R$ ${contratoPago.toFixed(2)} | 
                  Restante: R$ ${(contratoTotal - contratoPago).toFixed(2)}
                </div>
                <table>
                  <thead>
                    <tr>
                      <th>Parcela</th>
                      <th>Vencimento</th>
                      <th>Valor (R$)</th>
                      <th>Status</th>
                      <th>A√ß√£o</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            contrato.parcelas.forEach(p => {
              const estahAtrasada = !p.paid && new Date(p.vencimento) < hoje;
              let statusRow = p.paid ? 'paid' : (estahAtrasada ? 'atrasado' : '');
              let statusText = p.paid ? 'Pago' : (estahAtrasada ? 'Atrasado' : 'Pendente');
              let parcelaTexto = p.tipo.includes("Entrada") ? p.tipo : `${p.parcela}/${p.total_parcelas}`;
              contratoHTML += `
                <tr class="${statusRow}">
                  <td>${parcelaTexto}</td>
                  <td>${formatarData(p.vencimento)}</td>
                  <td>R$ ${p.valor.toFixed(2)}</td>
                  <td>${statusText}</td>
                  <td><button onclick="togglePagamento('${p.id}', ${p.paid})">${p.paid ? 'Desmarcar' : 'Marcar como Pago'}</button></td>
                </tr>
              `;
            });
            contratoHTML += `
                  </tbody>
                </table>
              </div>
            `;
          });

          clienteParcelas.innerHTML = contratoHTML;
          clienteCard.appendChild(clienteHeader);
          clienteCard.appendChild(clienteResumo);
          clienteCard.appendChild(clienteParcelas);
          listaClientes.appendChild(clienteCard);
        });

        if (listaClientes.children.length === 0) {
          listaClientes.innerHTML = '<p>Nenhum cliente encontrado com os filtros atuais.</p>';
        }
      } catch (error) {
        console.error("Erro ao listar clientes:", error);
      }
    }

    // Fun√ß√£o para alterar o status de pagamento de uma parcela
    async function togglePagamento(id, currentStatus) {
      try {
        const parcelaRef = doc(db, "parcelas", id);
        await updateDoc(parcelaRef, { paid: !currentStatus });
        listarClientes();
      } catch (error) {
        console.error("Erro ao atualizar status:", error);
      }
    }

    // Fun√ß√£o para editar um contrato (buscando as parcelas pelo contrato_id)
    async function editarContrato(contratoId) {
      try {
        const q = query(collection(db, "parcelas"), where("contrato_id", "==", contratoId));
        const querySnapshot = await getDocs(q);
        if (querySnapshot.empty) {
          alert('Contrato n√£o encontrado!');
          return;
        }
        let parcelasContrato = [];
        querySnapshot.forEach(docSnap => {
          let data = docSnap.data();
          data.docId = docSnap.id;
          parcelasContrato.push(data);
        });
        const temParcelasPagas = parcelasContrato.some(p => p.paid);
        if (temParcelasPagas) {
          alert('N√£o √© poss√≠vel editar um contrato que j√° possui parcelas pagas.');
          return;
        }
        const primeiraParcelaInfo = parcelasContrato[0];
        document.getElementById('nome').value = primeiraParcelaInfo.nome;
        document.getElementById('cpf').value = primeiraParcelaInfo.cpf;
        document.getElementById('contrato').value = primeiraParcelaInfo.contrato;
        const valorTotal = parcelasContrato.reduce((sum, p) => sum + p.valor, 0);
        document.getElementById('valorTotal').value = valorTotal;
        const tipoEntrada = parcelasContrato.find(p => p.tipo.includes("Entrada"));
        document.getElementById('valorEntrada').value = tipoEntrada ? tipoEntrada.valor : 0;
        const parcelasNormais = parcelasContrato.filter(p => p.tipo === "Parcela Regular" || p.tipo === "Pagamento √† Vista");
        const temParcelas = parcelasNormais.length > 0;
        document.getElementById('temParcelas').checked = temParcelas;
        document.getElementById('camposParcelas').style.display = temParcelas ? 'block' : 'none';
        if (temParcelas) {
          document.getElementById('parcelas').value = parcelasNormais[0].total_parcelas;
          const dataInicio = parcelasNormais.sort((a, b) => new Date(a.vencimento) - new Date(b.vencimento))[0].vencimento;
          document.getElementById('inicioParcelas').value = dataInicio;
        }
        document.getElementById('modoEdicao').value = 'true';
        document.getElementById('editandoId').value = contratoId;
        document.getElementById('titulo-formulario').textContent = 'Editar Contrato';
        document.getElementById('btnSalvar').textContent = 'Salvar Altera√ß√µes';
        document.getElementById('btnCancelar').style.display = 'inline-block';
        mostrarAba('cadastro');
      } catch (error) {
        console.error("Erro ao editar contrato:", error);
      }
    }

    // Fun√ß√£o para excluir todas as parcelas de um contrato pelo contrato_id
    async function excluirParcelasPorContrato(contratoId) {
      try {
        const q = query(collection(db, "parcelas"), where("contrato_id", "==", contratoId));
        const querySnapshot = await getDocs(q);
        for (const docSnap of querySnapshot.docs) {
          await deleteDoc(doc(db, "parcelas", docSnap.id));
        }
      } catch (error) {
        console.error("Erro ao excluir parcelas:", error);
      }
    }

    // Fun√ß√£o para confirmar a exclus√£o (usada no modal)
    async function confirmarExclusao() {
      if (!window.contratoParaExcluir) return;
      try {
        await excluirParcelasPorContrato(window.contratoParaExcluir);
        document.getElementById('modalConfirmacao').style.display = 'none';
        window.contratoParaExcluir = null;
        listarClientes();
        alert('Contrato exclu√≠do com sucesso!');
      } catch (error) {
        console.error('Erro ao excluir:', error);
        alert('Erro ao excluir o contrato. Por favor, tente novamente.');
      }
    }

    // Define o contrato a ser exclu√≠do e exibe o modal de confirma√ß√£o
    function excluirContrato(contratoId) {
      window.contratoParaExcluir = contratoId;
      document.getElementById('modalConfirmacao').style.display = 'block';
    }

    // Fun√ß√£o para fechar o modal de confirma√ß√£o
    function fecharModal() {
      document.getElementById('modalConfirmacao').style.display = 'none';
      window.contratoParaExcluir = null;
      listarClientes();
    }

    // Fun√ß√£o para formatar CPF (xxx.xxx.xxx-xx)
    function formatarCPF(cpf) {
      cpf = cpf.replace(/\D/g, '');
      if (cpf.length === 11) {
        return cpf.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
      }
      return cpf;
    }

    // Verifica se o cliente corresponde ao termo de pesquisa
    function clienteCorrespondeAPesquisa(cliente, termo) {
      const nome = cliente.nome.toLowerCase();
      const cpf = cliente.cpf.toLowerCase();
      const contratos = [...new Set(cliente.parcelas.map(p => p.contrato.toLowerCase()))];
      return nome.includes(termo) ||
             cpf.includes(termo) ||
             contratos.some(c => c.includes(termo));
    }

    // Alterna a exibi√ß√£o das parcelas de um cliente
    function toggleParcelas(clienteId) {
      const parcelasDiv = document.getElementById(`parcelas-${clienteId}`);
      if (parcelasDiv.style.display === 'none' || !parcelasDiv.style.display) {
        parcelasDiv.style.display = 'block';
        clientesExpandidos[clienteId] = true;
      } else {
        parcelasDiv.style.display = 'none';
        clientesExpandidos[clienteId] = false;
      }
    }

    // Alterna a exibi√ß√£o de todos os clientes
    function toggleTodosClientes() {
      const todosExpandidos = Object.values(clientesExpandidos).every(v => v);
      const divsParcelas = document.querySelectorAll('.cliente-parcelas');
      divsParcelas.forEach(div => {
        const clienteId = div.id.replace('parcelas-', '');
        div.style.display = todosExpandidos ? 'none' : 'block';
        clientesExpandidos[clienteId] = !todosExpandidos;
      });
    }

    // Fun√ß√£o para pesquisar clientes
    function pesquisarClientes() {
      listarClientes();
    }

    // Formata data (YYYY-MM-DD para DD/MM/YYYY)
    function formatarData(dataStr) {
      const data = new Date(dataStr);
      return `${data.getDate().toString().padStart(2, '0')}/${(data.getMonth() + 1).toString().padStart(2, '0')}/${data.getFullYear()}`;
    }

    // Cancela o modo de edi√ß√£o e reseta o formul√°rio
    function cancelarEdicao() {
      document.getElementById('modoEdicao').value = 'false';
      document.getElementById('editandoId').value = '';
      document.getElementById('titulo-formulario').textContent = 'Adicionar Pagamento';
      document.getElementById('btnSalvar').textContent = 'Adicionar Pagamento';
      document.getElementById('btnCancelar').style.display = 'none';
      limparFormulario();
    }

    // Limpa os campos do formul√°rio
    function limparFormulario() {
      document.getElementById('nome').value = '';
      document.getElementById('cpf').value = '';
      document.getElementById('contrato').value = '';
      document.getElementById('valorTotal').value = '';
      document.getElementById('valorEntrada').value = '0';
      document.getElementById('parcelas').value = '1';
      const today = new Date();
      document.getElementById('inicioParcelas').value = today.toISOString().split('T')[0];
    }

    // Fun√ß√£o para exportar os dados em JSON (opcional)
    async function exportarJSON() {
      try {
        const querySnapshot = await getDocs(collection(db, "parcelas"));
        const allData = [];
        querySnapshot.forEach(docSnap => {
          let data = docSnap.data();
          data.id = docSnap.id;
          allData.push(data);
        });
        const dados = {
          parcelas: allData,
          dataExportacao: new Date().toISOString()
        };
        const jsonString = JSON.stringify(dados, null, 2);
        const blob = new Blob([jsonString], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `controle-parcelas-${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (error) {
        console.error("Erro ao exportar JSON:", error);
      }
    }

    // Fun√ß√£o para importar dados em JSON (opcional)
    function importarJSON() {
      const input = document.getElementById('importFile');
      input.onchange = async function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = async function(event) {
          try {
            const dados = JSON.parse(event.target.result);
            if (!dados.parcelas || !Array.isArray(dados.parcelas)) {
              throw new Error('Formato de arquivo inv√°lido');
            }
            if (confirm('Isso ir√° substituir todos os dados existentes. Deseja continuar?')) {
              // Para simplificar, adicionamos os documentos sem excluir os existentes
              for (const parcela of dados.parcelas) {
                await addDoc(collection(db, "parcelas"), parcela);
              }
              listarClientes();
              alert('Dados importados com sucesso!');
            }
          } catch (error) {
            alert('Erro ao importar arquivo: ' + error.message);
          }
          input.value = '';
        };
        reader.readAsText(file);
      };
      input.click();
    }

    // Formata√ß√£o do CPF enquanto o usu√°rio digita
    function formatCPFInput(input) {
      let value = input.value.replace(/\D/g, '');
      if (value.length > 11) value = value.slice(0, 11);
      if (value.length >= 3 && value.length < 6)
        value = value.replace(/^(\d{3})(\d{0,3})/, '$1.$2');
      else if (value.length >= 6 && value.length < 9)
        value = value.replace(/^(\d{3})(\d{3})(\d{0,3})/, '$1.$2.$3');
      else if (value.length >= 9)
        value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2})/, '$1.$2.$3-$4');
      input.value = value;
    }
    document.getElementById('cpf').addEventListener('input', function() {
      formatCPFInput(this);
    });

    // Eventos iniciais
    document.getElementById('temParcelas').addEventListener('change', function() {
      document.getElementById('camposParcelas').style.display = this.checked ? 'block' : 'none';
    });

    document.addEventListener('DOMContentLoaded', function() {
      const today = new Date();
      document.getElementById('inicioParcelas').value = today.toISOString().split('T')[0];
      document.getElementById('mostrarPendentes').addEventListener('change', listarClientes);
      document.getElementById('mostrarPagos').addEventListener('change', listarClientes);
      document.getElementById('mostrarAtrasados').addEventListener('change', listarClientes);
      listarClientes();
    });

    // Fun√ß√£o para alternar entre abas
    function mostrarAba(abaId) {
      const abas = document.querySelectorAll('.tab-content');
      abas.forEach(aba => aba.style.display = 'none');
      document.getElementById(abaId).style.display = 'block';
      const botoes = document.querySelectorAll('.tab-button');
      botoes.forEach(botao => botao.classList.remove('active'));
      event.target.classList.add('active');
      if (abaId === 'clientes') {
        listarClientes();
      }
    }

    // Exp√µe as fun√ß√µes para o escopo global (usado nos onclick dos bot√µes)
    window.adicionarPagamento = adicionarPagamento;
    window.listarClientes = listarClientes;
    window.togglePagamento = togglePagamento;
    window.editarContrato = editarContrato;
    window.excluirContrato = excluirContrato;
    window.confirmarExclusao = confirmarExclusao;
    window.fecharModal = fecharModal;
    window.toggleParcelas = toggleParcelas;
    window.toggleTodosClientes = toggleTodosClientes;
    window.pesquisarClientes = pesquisarClientes;
    window.exportarJSON = exportarJSON;
    window.importarJSON = importarJSON;
    window.cancelarEdicao = cancelarEdicao;
  </script>
</body>
</html>
